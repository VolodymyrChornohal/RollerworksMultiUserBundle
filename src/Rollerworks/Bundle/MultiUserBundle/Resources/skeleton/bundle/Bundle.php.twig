<?php

namespace {{ namespace }};

{% block use_statements %}
use Symfony\Component\HttpKernel\Bundle\Bundle;
{% endblock use_statements %}

{% block class_definition %}
class {{ bundle }} extends Bundle
{% endblock class_definition %}
{
{% block class_body %}
    /**
     * {@inheritdoc}
     */
    public function build(ContainerBuilder $container)
    {
        parent::build($container);

        $this->addRegisterMappingsPass($container, '{{ extension_alias }}');
    }

    /**
     * Registers the DoctrineMappingsPass for loading the FOSUserBundle base-mappings
     * with the correct driver and model-manager.
     *
     * @param ContainerBuilder $container
     */
    private function addRegisterMappingsPass(ContainerBuilder $container, $servicePrefix)
    {
        $r = new \ReflectionClass('FOS\UserBundle\FOSUserBundle');

        $mappings = array(
            realpath(dirname($r->getFilename()).'/Resources/config/doctrine/model') => 'FOS\UserBundle\Model',
        );

        if (class_exists('Doctrine\Bundle\DoctrineBundle\DependencyInjection\Compiler\DoctrineOrmMappingsPass')) {
            $container->addCompilerPass(DoctrineOrmMappingsPass::createXmlMappingDriver($mappings, array($servicePrefix.'.model_manager_name'), '.backend_type_orm'));
        }

        if (class_exists('Doctrine\Bundle\MongoDBBundle\DependencyInjection\Compiler\DoctrineMongoDBMappingsPass')) {
            $container->addCompilerPass(DoctrineMongoDBMappingsPass::createXmlMappingDriver($mappings, array($servicePrefix.'.model_manager_name'), $servicePrefix.'.backend_type_mongodb'));
        }

        if (class_exists('Doctrine\Bundle\CouchDBBundle\DependencyInjection\Compiler\DoctrineCouchDBMappingsPass')) {
            $container->addCompilerPass(DoctrineCouchDBMappingsPass::createXmlMappingDriver($mappings, array($servicePrefix.'.model_manager_name'), $servicePrefix.'.backend_type_couchdb'));
        }
    }
{% endblock class_body %}
}
